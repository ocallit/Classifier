<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TagIt Demo</title>

    <!-- ClassifyIt dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../src/ClassifyIt.css">
    <script src="../src/ClassifyIt.js"></script>

    <!-- TagIt dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>
    <link rel="stylesheet" href="../src/TagIt.css">
    <script src="../src/DialogIt.js"></script>
    <script src="../src/TagIt.js"></script>

    <style>
        select { background-color: white; }
        .demo-container { padding: 2rem; font-family: system-ui, sans-serif; max-width: 50em; }
        .demo-section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #dee2e6; border-radius: 6px; }
        .demo-section h2 { margin-top: 0; font-size: 1.1rem; color: #2c3e50; }
        .demo-section p { font-size: 0.85rem; color: #6c757d; margin: 0.5rem 0; }
        .demo-section code { background: #f0f0f0; padding: 2px 5px; border-radius: 3px; font-size: 0.8rem; }
    </style>

    <style id="common-to-all-pages">
        .ontoy-dlg, .ontoy-dlg * { box-sizing: border-box; }
        .ontoy-dlg::backdrop { background-color: transparent; backdrop-filter: none !important; }
        .ontoy-dlg[open] { display: flex; flex-direction: column; }
        .ontoy-dlg {
            resize: both;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            padding: 0;
            border: 1px solid #888;
            border-radius: 6px;
            min-width: 300px;
            width: fit-content;
            max-width: 95vw;
            min-height: 200px;
            height: fit-content;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            background: white;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .ontoy-dlg-header {
            background: #2c3e50; color: white; padding: 12px 16px; width: 100%;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            cursor: move; flex: 0 0 auto; user-select: none;
        }
        .ontoy-dlg-content {
            padding: 1rem; display: flex; flex-direction: column; justify-content: start;
            gap: 1rem; flex: 1 1 auto; min-height: 100px;
            overflow-y: auto; overflow-x: hidden; width: 100%;
        }
        .ontoy-dlg-footer {
            padding: 1rem; border-top: 1px solid #e2e8f0; background: #f8fafc;
            display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 0.75rem;
            width: 100%; flex: 0 0 auto;
        }
        .ontoy-dlg-close {
            cursor: pointer; background: none; border: none; color: white;
            font-size: 1.5rem; line-height: 1; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px; transition: background 0.2s;
        }
        .ontoy-dlg-close:hover { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>TagIt + ClassifyIt Demo</h1>

        <!-- Demo 1: Server-rendered, no classifier -->
        <div class="demo-section">
            <h2>1. Server-rendered (auto-init, no classifier)</h2>
            <p>Standard TagIt. Options pre-rendered in HTML.</p>
            <div class="form-group" style="width:30em">
                <label for="categories">Categor√≠as</label>
                <select id="categories" multiple
                        data-tagit
                        data-tagit-rw
                        data-tagit-catalogid="1"
                        data-tagit-table="producto_general_id"
                        data-tagit-title="Categorias de Productos"
                        data-tagit-apiurl="./api/tagit_api.php"
                >
                    <option value="a1">Deportes</option>
                    <option value="b2">Escolar</option>
                    <option value="c3" selected="selected">Nuevo</option>
                    <option value="d4" selected="selected">Primavera</option>
                    <option value="e5">Invierno</option>
                </select>
            </div>
        </div>

        <!-- Demo 2: With ClassifyIt (editable) -->
        <div class="demo-section">
            <h2>2. With ClassifyIt ‚Äî editable</h2>
            <p>Click üè∑Ô∏è on any tag to open ClassifyIt. Drag products between columns to add/remove the tag.</p>
            <div class="form-group" style="width:30em">
                <label for="cat-classify-edit">Categor√≠as (Producto: Bal√≥n Nike)</label>
                <select id="cat-classify-edit" multiple>
                    <option value="a1" selected="selected">Deportes</option>
                    <option value="b2">Escolar</option>
                    <option value="c3" selected="selected">Nuevo</option>
                    <option value="d4">Primavera</option>
                    <option value="e5">Invierno</option>
                </select>
            </div>
        </div>

        <!-- Demo 3: With ClassifyIt (readonly) -->
        <div class="demo-section">
            <h2>3. With ClassifyIt ‚Äî read only</h2>
            <p>Same üè∑Ô∏è button, but ClassifyIt opens in read-only mode. No drag, no save.</p>
            <div class="form-group" style="width:30em">
                <label for="cat-classify-ro">Categor√≠as (solo lectura)</label>
                <select id="cat-classify-ro" multiple data-tagit-ro>
                    <option value="a1" selected="selected">Deportes</option>
                    <option value="b2">Escolar</option>
                    <option value="c3" selected="selected">Nuevo</option>
                    <option value="d4">Primavera</option>
                    <option value="e5">Invierno</option>
                </select>
            </div>
        </div>

        <!-- Demo 4: Dynamic fetch -->
        <div class="demo-section">
            <h2>4. Dynamic fetch (empty select ‚Üí <code>tagGetItemTags</code>)</h2>
            <p>Select starts empty. Tags fetched from mock API on init.</p>
            <div class="form-group" style="width:30em">
                <label for="cat-dynamic">Categor√≠as (Producto #42)</label>
                <select id="cat-dynamic" multiple
                        data-tagit
                        data-tagit-rw
                        data-tagit-catalogid="1"
                        data-tagit-itemid="42"
                        data-tagit-table="producto_general_id"
                        data-tagit-title="Categorias (Producto #42)"
                        data-tagit-apiurl="./api/tagit_api.php"
                >
                </select>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // Mock data
        // ============================================================
        const MOCK_DELAY = 300;

        const mockTags = [
            {id: 'a1', text: 'Deportes'},
            {id: 'b2', text: 'Escolar'},
            {id: 'c3', text: 'Nuevo'},
            {id: 'd4', text: 'Primavera'},
            {id: 'e5', text: 'Invierno'}
        ];

        // Products in the catalog, each with their tag ids
        const mockProducts = [
            {id: 'p1',  name: 'Bal√≥n Nike',          tags: ['a1', 'c3']},
            {id: 'p2',  name: 'Raqueta Wilson',       tags: ['a1']},
            {id: 'p3',  name: 'Cuaderno Scribe 100h', tags: ['b2']},
            {id: 'p4',  name: 'Mochila Jansport',     tags: ['b2', 'c3']},
            {id: 'p5',  name: 'Guantes T√©rmicos',     tags: ['a1', 'e5']},
            {id: 'p6',  name: 'Sudadera Adidas',      tags: ['a1', 'e5', 'c3']},
            {id: 'p7',  name: 'Sandalias Playa',      tags: ['d4']},
            {id: 'p8',  name: 'Lentes de Sol Ray-Ban', tags: ['d4', 'c3']},
            {id: 'p9',  name: 'Patines Roller Derby',  tags: ['a1', 'd4']},
            {id: 'p10', name: 'Plumas BIC 12 pack',   tags: ['b2']},
            {id: 'p11', name: 'Chamarra North Face',   tags: ['e5']},
            {id: 'p12', name: 'Gorra Under Armour',    tags: ['a1', 'd4', 'c3']}
        ];

        // Which tags does a specific item have? (for tagGetItemTags)
        const mockItemTags = {
            '42': ['c3', 'e5']
        };

        // ============================================================
        // Mock fetch interceptor
        // ============================================================
        (function() {
            const originalFetch = window.fetch;

            window.fetch = function(url, options) {
                if(options && options.method === 'POST' && String(url).includes('tagit_api')) {
                    const params = new URLSearchParams(options.body);
                    const action = params.get('action');

                    console.log('[MockAPI]', action, Object.fromEntries(params));

                    return new Promise(resolve => {
                        setTimeout(() => {
                            let result = { success: false, error: 'Unknown action', data: null };

                            switch(action) {
                                case 'tagGetItemTags': {
                                    const itemIdKey = params.get('item_id');
                                    const selectedIds = mockItemTags[itemIdKey] || [];
                                    const tags = mockTags.map(t => ({
                                        value: t.id,
                                        text: t.text,
                                        selected: selectedIds.includes(t.id)
                                    }));
                                    result = { success: true, error: null, data: { tags: tags } };
                                    break;
                                }

                                case 'tagAdd': {
                                    const text = params.get('text');
                                    const exists = mockTags.some(t =>
                                        t.text.toLowerCase() === text.toLowerCase()
                                    );
                                    if(exists) {
                                        result = { success: false, error: 'Item already exists', data: null };
                                    } else {
                                        const newId = Date.now().toString();
                                        mockTags.push({ id: newId, text: text });
                                        result = { success: true, error: null, data: { id: newId } };
                                    }
                                    break;
                                }

                                case 'tagUpdate': {
                                    const id = params.get('id');
                                    const text = params.get('text');
                                    const idx = mockTags.findIndex(t => t.id === id);
                                    if(idx !== -1) {
                                        mockTags[idx].text = text;
                                        result = { success: true, error: null, data: null };
                                    } else {
                                        result = { success: false, error: 'Item not found', data: null };
                                    }
                                    break;
                                }

                                case 'tagDelete': {
                                    const id = params.get('id');
                                    const idx = mockTags.findIndex(t => t.id === id);
                                    if(idx !== -1) {
                                        mockTags.splice(idx, 1);
                                        result = { success: true, error: null, data: null };
                                    } else {
                                        result = { success: false, error: 'Item not found', data: null };
                                    }
                                    break;
                                }
                            }

                            resolve(new Response(JSON.stringify(result), {
                                status: 200,
                                headers: { 'Content-Type': 'application/json' }
                            }));
                        }, MOCK_DELAY);
                    });
                }

                return originalFetch.apply(this, arguments);
            };
        })();

        // ============================================================
        // ClassifyIt integration helper
        // ============================================================

        /**
         * Opens ClassifyIt for a given tag.
         * Categories: "Con etiqueta" / "Sin etiqueta"
         * Items: all products, placed by whether they have the tag.
         */
        function openClassifierForTag(tagValue, tagText, readOnly) {
            const tag = mockTags.find(t => t.id === tagValue);
            if(!tag) return;

            const categories = [
                { id: 'has_tag',  label: '‚úì', title: 'Con: ' + tagText },
                { id: 'no_tag',   label: '‚úó', title: 'Sin: ' + tagText }
            ];

            const items = mockProducts.map(p => ({
                id: p.id,
                name: p.name,
                category: p.tags.includes(tagValue) ? 'has_tag' : 'no_tag'
            }));

            const classifier = new ClassifyIt(categories, items, {
                title: 'Productos ‚Äî ' + tagText,
                itemNamePlural: 'Productos',
                editable: !readOnly,
                showItemButtons: !readOnly,
                presetsEnabled: true,
                groupEnabled: false
            });

            classifier.openDialog()
                .then(result => {
                    console.log('[ClassifyIt] Saved:', result);
                    // In production: POST result back to sync tag assignments
                })
                .catch(err => {
                    console.log('[ClassifyIt] Cancelled');
                });
        }

        // ============================================================
        // Programmatic TagIt inits (Demos 2 & 3)
        // ============================================================
        document.addEventListener('DOMContentLoaded', function() {

            // Demo 2: editable + classifier
            new TagIt(document.getElementById('cat-classify-edit'), {
                apiUrl: './api/tagit_api.php',
                catalogId: '1',
                dialogTitle: 'Categorias de Productos',
                classifier: true,
                onClassify: openClassifierForTag
            });

            // Demo 3: readonly + classifier
            new TagIt(document.getElementById('cat-classify-ro'), {
                apiUrl: './api/tagit_api.php',
                catalogId: '1',
                dialogTitle: 'Categorias de Productos',
                readOnly: true,
                classifier: true,
                onClassify: openClassifierForTag
            });
        });
    </script>
</body>
</html>
